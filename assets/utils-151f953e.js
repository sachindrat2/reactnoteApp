var e=Object.defineProperty,o=Object.defineProperties,t=Object.getOwnPropertyDescriptors,n=Object.getOwnPropertySymbols,r=Object.prototype.hasOwnProperty,s=Object.prototype.propertyIsEnumerable,a=(o,t,n)=>t in o?e(o,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):o[t]=n,i=(e,o)=>{for(var t in o||(o={}))r.call(o,t)&&a(e,t,o[t]);if(n)for(var t of n(o))s.call(o,t)&&a(e,t,o[t]);return e},l=(e,n)=>o(e,t(n)),c=(e,o,t)=>new Promise((n,r)=>{var s=e=>{try{i(t.next(e))}catch(o){r(o)}},a=e=>{try{i(t.throw(e))}catch(o){r(o)}},i=e=>e.done?n(e.value):Promise.resolve(e.value).then(s,a);i((t=t.apply(e,o)).next())});const d="https://notesapp.agreeableocean-d7058ab3.japanwest.azurecontainerapps.io";console.log("API Service loaded - Version: 2.0.0 - Environment: Production");let u=new Map,p=0;const g=()=>(()=>{const e=d.startsWith("http")?d:`https://${d}`;return console.log("Backend URL:",e),e})(),h="/token",m="/register",f="/logout",y="/notes",v="/refresh",w="/verify-email",T="/forgot-password",E="/reset-password",S="/profile",O="/profile/avatar",b="/profile/username",P="/profile/email",C=()=>c(void 0,null,function*(){const e=`${g()}${v}`;try{const o=yield fetch(e,{method:"POST",credentials:"include",headers:{Accept:"application/json","Cache-Control":"no-cache"}});if(!o.ok){if(401===o.status)throw console.log("Refresh token expired or invalid (401)"),new Error("Refresh token expired - please login again");throw new Error(`Failed to refresh token: ${o.status} ${o.statusText}`)}return yield o.json()}catch(o){throw console.error("Token refresh error:",o.message),o}}),k=()=>{const e=localStorage.getItem("notesapp_user");if(!e)return console.log("No authentication data founds"),{"Content-Type":"application/json"};let o;try{o=JSON.parse(e)}catch(r){return console.error("Error parsing user data from localStorage:",r),localStorage.removeItem("notesapp_user"),{"Content-Type":"application/json"}}const t=o.access_token;if(!t)return console.warn("No access token found in user data"),{"Content-Type":"application/json"};const n=`Bearer ${t.substring(0,30)}...`;return console.log("ğŸ”‘ Using access token for authentication"),console.log("   - Authorization header:",n),{"Content-Type":"application/json",Authorization:`Bearer ${t}`}},N=(e,...o)=>c(void 0,[e,...o],function*(e,o={}){const t=++p,n=`${o.method||"GET"}_${e}`;if(u.has(n))return console.log(`â¸ï¸ Request ${t}: Duplicate ${n} detected, waiting for existing request...`),yield u.get(n);console.log(`ğŸš€ Request ${t}: Starting ${n} at ${(new Date).toISOString()}`);const r=c(void 0,null,function*(){try{const r=`${g()}${e}`,s=yield R(r,o,e);return console.log(`âœ… Request ${t}: ${n} completed successfully`),s}finally{u.delete(n)}});return u.set(n,r),yield r}),R=(e,...o)=>c(void 0,[e,...o],function*(e,o={},t){var n;const r=i({headers:i(i(l(i({},k()),{Accept:"application/json"}),o.body&&!(null==(n=o.headers)?void 0:n["Content-Type"])?{"Content-Type":"application/json"}:{}),o.headers),mode:"cors",credentials:"omit",cache:"no-cache"},o),s=new Promise((e,o)=>{setTimeout(()=>o(new Error("Request timeout")),15e3)});try{const o=yield Promise.race([fetch(e,r),s]);console.log("Response Status:",o.status);const n=o.headers.get("content-type");let i;try{if(n&&n.includes("application/json"))i=yield o.json();else{const e=yield o.text();if(e&&""!==e.trim())try{i=JSON.parse(e)}catch(a){i=e}else i=null}}catch(c){console.error("Error parsing response:",c),i=null}if(console.log("Processed Response Data:",i),!o.ok){if(console.error("API Error Response:",{status:o.status,statusText:o.statusText,url:e,data:i}),401===o.status)throw console.log("ğŸš« 401 Unauthorized - clearing auth and triggering event"),console.log("ğŸ§¹ Clearing invalid token from localStorage after 401"),localStorage.removeItem("notesapp_user"),console.log("Dispatching token expiration event due to 401 error"),window.dispatchEvent(new CustomEvent("auth:token-expired",{detail:{reason:"API returned 401 Unauthorized",endpoint:t,url:e}})),new Error("401: Unauthorized - Session expired");if("/token"===t&&i&&(i.access_token||"object"==typeof i&&null!==i&&Object.keys(i).length>0))return console.log("Token endpoint returned error status but has valid data, treating as success"),i;const n=(null==i?void 0:i.detail)||(null==i?void 0:i.message)||("string"==typeof i?i:JSON.stringify(i))||`HTTP error! status: ${o.status} ${o.statusText}`;throw new Error(n)}return i}catch(d){if(console.error("API request failed:",d),(e=>{const o=e.toString().toLowerCase();return["CORS","Cross-Origin","Access-Control","No 'Access-Control-Allow-Origin'","has been blocked by CORS policy","preflight"].some(e=>o.includes(e.toLowerCase()))})(d))throw console.error("CORS Error Detected:",d.message),new Error("CORS_ERROR: Unable to connect to server due to CORS policy restrictions.");if("TypeError"===d.name&&d.message.includes("Failed to fetch"))throw console.error("Network Error - unable to connect to server"),new Error("NETWORK_ERROR: Unable to connect to server. Please check your internet connection and try again.");if(d.message.includes("ERR_TUNNEL_CONNECTION_FAILED"))throw console.error("ğŸš‡ Tunnel Connection Failed - server unreachable"),new Error("TUNNEL_CONNECTION_FAILED: Unable to establish connection to server. Server may be down or unreachable.");if(d.message.includes("timeout"))throw console.error("â° Request Timeout - server too slow"),new Error("TIMEOUT_ERROR: Server is taking too long to respond (>30 seconds). Please check your connection or try again later.");throw d}}),I={login:(e,o)=>c(void 0,null,function*(){const t=new URLSearchParams;return t.append("username",e),t.append("password",o),console.log("Login attempt with:",{email:e,password:o?"[HIDDEN]":"EMPTY"}),console.log("Form data:",t.toString()),N(h,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:t.toString(),credentials:"include"})}),register:(e,o,t)=>c(void 0,null,function*(){let n;return n="object"==typeof e&&null!==e?e:{username:e,email:o,password:t},console.log("Registration payload:",l(i({},n),{password:"[HIDDEN]"})),N(m,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)})}),logout:()=>c(void 0,null,function*(){return N(f,{method:"POST"})}),verifyEmail:e=>c(void 0,null,function*(){return N(`${w}?token=${e}`,{method:"GET"})}),forgotPassword:e=>c(void 0,null,function*(){return N(T,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e})})}),resetPassword:(e,o)=>c(void 0,null,function*(){return N(E,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:e,password:o})})}),getProfile:()=>c(void 0,null,function*(){return N(S,{method:"GET"})}),updateProfile:e=>c(void 0,null,function*(){const o=e instanceof FormData;return N(S,{method:"PUT",headers:o?{}:{"Content-Type":"application/json"},body:o?e:JSON.stringify(e)})}),updateUsername:e=>c(void 0,null,function*(){return N(b,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({new_username:e})})}),updateEmail:e=>c(void 0,null,function*(){return N(P,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({new_email:e})})}),uploadAvatar:e=>c(void 0,null,function*(){const o=new FormData;return o.append("avatar",e),N(O,{method:"POST",body:o})}),removeAvatar:()=>c(void 0,null,function*(){return N(O,{method:"DELETE"})})},$={getAllNotes:()=>c(void 0,null,function*(){var e,o;console.log("ğŸ“‹ Fetching all notes...");const t=JSON.parse(localStorage.getItem("notesapp_user")||"{}");console.log("ğŸ‘¤ Current user for notes fetch:",{email:(null==(e=t.user)?void 0:e.email)||t.email,id:(null==(o=t.user)?void 0:o.id)||t.id,hasToken:!(!t.access_token&&!t.token)});const n=yield N(y,{method:"GET"});return console.log("ğŸ“‹ getAllNotes API result:",n),n}),createNote:e=>c(void 0,null,function*(){console.log("ğŸ“ Creating note with data:",e),console.log("ğŸ“ Tags being sent:",e.tags),console.log("ğŸ“ Images being sent:",e.images);const o=yield N(y,{method:"POST",body:JSON.stringify(e)});return console.log("ğŸ“ Create note API response:",o),o}),updateNote:(e,o)=>c(void 0,null,function*(){console.log("ğŸ“ Updating note with data:",o),console.log("ğŸ“ Tags being updated:",o.tags),console.log("ğŸ“ Images being updated:",o.images);const t=yield N(`${y}/${e}`,{method:"PUT",body:JSON.stringify(o)});return console.log("ğŸ“ Update note API response:",t),t}),deleteNote:e=>c(void 0,null,function*(){return N(`${y}/${e}`,{method:"DELETE"})}),getNoteById:e=>c(void 0,null,function*(){return N(`${y}/${e}`,{method:"GET"})})},j=e=>{if(console.log("ğŸ” Handling API error:",e.message),e.message.includes("401")||e.message.includes("Unauthorized")){console.log("ğŸš« 401 error detected - token expired or invalid");const e=localStorage.getItem("notesapp_user");if(e)try{const o=JSON.parse(e);(o.access_token||o.token)&&(console.log("ğŸ§¹ Clearing expired/invalid token from localStorage"),localStorage.removeItem("notesapp_user"),console.log("ï¿½ Dispatching token expiration event due to 401 in handleAPIError"),window.dispatchEvent(new CustomEvent("auth:token-expired",{detail:{reason:"Token expired or invalid (401 error)"}})))}catch(o){console.error("Error parsing stored user data during 401 handling:",o),localStorage.removeItem("notesapp_user")}return"Your session has expired. Please login again."}return e.message.includes("Network error")||e.message.includes("Failed to fetch")?"Unable to connect to server. Please check your internet connection and try again.":e.message.includes("CORS")?"Connection blocked by browser security. Please try refreshing the page.":e.message||"An unexpected error occurred."};export{I as a,j as h,$ as n,C as r};
